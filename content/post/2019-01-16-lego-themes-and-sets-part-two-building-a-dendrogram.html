---
title: Lego themes and sets - part two
subtitle: Building a dendrogram
author: Rikke Barsten
date: '2019-01-19'
slug: lego-themes-and-sets-part-two
categories: []
tags: [R, d3, javascript, dendrogram, visualization, lego]
showtoc: FALSE
---



<p>In the previous post I output a dendrogram using the networkD3 R package. In this post, I use D3 directly to make a nicely formatted and customized version of this dendrogram.</p>
<p>D3 can take many data format as input, but since my lego data is already in hierarchical format, it is easy to use the rjson library to convert it to a JSON object:</p>
<pre class="r"><code>library(rjson)

star_wars_json &lt;- toJSON(ToListExplicit(star_wars, unname=TRUE))
write(star_wars_json, &quot;/data/star_wars.json&quot;)</code></pre>
<p>I’ve pasted the javascript code in at the end of the post, but here’s the resulting visualization of the Star Wars subtree:</p>
<svg width="800" height="7400">
</svg>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script type="text/javascript" src="/js/dendro.js"r></script>
<p>In this dendrogram vizualization I can control all parts of the output; colors, fonts, sizes, positioning and so forth. I borrowed the basic code for making the dendrogram from one of <a href="https://beta.observablehq.com/@mbostock/d3-cluster-dendrogram">Mike Bostocks ObservableHQ notebooks</a>, and made some adjustments. One of them is to add the release year to the sets ind the dendrogram. I do this by testing if a node has children. If not, it’s a set, and then I add the year.</p>
<p>This visualization is only a small part (735 out of 14974 nodes) of the original dataset. To be able to display all the data, I will need a dynamic and interactive visualization, that can zoom in on parts of the dataset. In the next post or two, I will try to make some examples of this, also using the d3 library.</p>
<p>Heres the code outputting the dendrogram:</p>
<pre class="js"><code>
var svg = d3.select(&quot;svg&quot;),
margin = {top: 5, right: 270, bottom: 5, left: 5},
width = +svg.attr(&quot;width&quot;) - margin.left - margin.right,
height = +svg.attr(&quot;height&quot;) - margin.top - margin.bottom;



d3.json(&quot;/data/star_wars.json&quot;).then(function(data) {
 

  const root = d3.hierarchy(data)
    .sort((a, b) =&gt; (a.height - b.height) || a.data.name.localeCompare(b.data.name));
    root.dx = 10;
    root.dy = width / (root.height + 1);
  


  d3.cluster().nodeSize([root.dx, root.dy])(root);

  let x0 = Infinity;
  let x1 = -x0;
  root.each(d =&gt; {
    if (d.x &gt; x1) x1 = d.x;
    if (d.x &lt; x0) x0 = d.x;
  });

 
    var g = svg.append(&quot;g&quot;)
      .attr(&quot;font-family&quot;, &quot;sans-serif&quot;)
      .attr(&quot;font-size&quot;, 10)
      .attr(&quot;transform&quot;, &#39;translate(${root.dy / 3},${root.dx - x0})&#39;);


  var link = g.append(&quot;g&quot;)
    .attr(&quot;fill&quot;, &quot;none&quot;)
    .attr(&quot;stroke&quot;, &quot;#555&quot;)
    .attr(&quot;stroke-opacity&quot;, 0.4)
    .attr(&quot;stroke-width&quot;, 1.5)
  .selectAll(&quot;path&quot;)
    .data(root.links())
    .enter().append(&quot;path&quot;)
      .attr(&quot;d&quot;, d =&gt; &#39;
        M${d.target.y},${d.target.x}
        C${d.source.y + root.dy / 2},${d.target.x}
         ${d.source.y + root.dy / 2},${d.source.x}
         ${d.source.y},${d.source.x}
      &#39;);


  var node = g.append(&quot;g&quot;)
      .attr(&quot;stroke-linejoin&quot;, &quot;round&quot;)
      .attr(&quot;stroke-width&quot;, 3)
    .selectAll(&quot;g&quot;)
    .data(root.descendants().reverse())
    .enter().append(&quot;g&quot;)
      .attr(&quot;transform&quot;, d =&gt; &#39;translate(${d.y},${d.x})&#39;);

  node.append(&quot;circle&quot;)
      .attr(&quot;fill&quot;, d =&gt; d.children ? &quot;#555&quot; : &quot;#999&quot;)
      .attr(&quot;r&quot;, 2.5);

  node.append(&quot;text&quot;)
      .attr(&quot;dy&quot;, &quot;0.31em&quot;)
      .attr(&quot;x&quot;, d =&gt; d.children ? -3 : 6)
      .text(d =&gt;  d.children ? d.data.name : d.data.name + &quot; - &quot; + d.data.year)
    .filter(d =&gt; d.children)
      .attr(&quot;text-anchor&quot;, &quot;end&quot;)
    .clone(true).lower()
      .attr(&quot;stroke&quot;, &quot;white&quot;);

});
</code></pre>
<p>Note that, since the R markdown javascript engine (which this blogpost is written in) does not handle <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">template literals</a>, I have replaced the backticks with single quotes in the code example above, so that it will be nicely formatted. The actual code running is loaded from the dendro.js file in my js-folder.</p>
